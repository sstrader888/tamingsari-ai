<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IronTune — Controller Calibration Hub by Iron Gamers</title>
  <meta name="description" content="IronTune — Controller Calibration Hub by Iron Gamers. Web-based tester & calibration untuk DualSense, DualShock 4 dan Xbox Controller.">
  <meta name="theme-color" content="#020617" />

  <!-- Tailwind CDN (untuk styling neon) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} },
      corePlugins: { preflight: true },
    }
  </script>

  <!-- React 18 + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel untuk support JSX dalam browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

</head>
<body class="bg-zinc-950 text-zinc-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ---------- Utility: Easing/Curves ----------
    function applyCurve(value, curve) {
      const v = Math.max(-1, Math.min(1, value));
      switch (curve) {
        case "expo": {
          const sign = Math.sign(v);
          const x = Math.abs(v);
          return sign * Math.pow(x, 1.7);
        }
        case "soft": {
          return Math.tanh(1.2 * v);
        }
        default:
          return v;
      }
    }

    function applyDeadzone(x, y, dz) {
      const r = Math.hypot(x, y);
      if (r < dz) return { x: 0, y: 0 };
      const scale = (r - dz) / (1 - dz);
      const nx = (x / r) * scale;
      const ny = (y / r) * scale;
      return { x: nx, y: ny };
    }

    function clamp01(n) {
      return Math.max(0, Math.min(1, n));
    }

    // ---------- Profiles ----------
    const DEFAULT_PROFILE = {
      name: "Default",
      createdAt: new Date().toISOString(),
      settings: {
        left: { deadzone: 0.07, curve: "linear" },
        right: { deadzone: 0.05, curve: "linear" },
        triggers: { l2Min: 0, l2Max: 1, r2Min: 0, r2Max: 1 },
      },
    };

    function loadProfiles() {
      try {
        const raw = localStorage.getItem("irontune_profiles_v1");
        if (!raw) return [DEFAULT_PROFILE];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || arr.length === 0) return [DEFAULT_PROFILE];
        return arr;
      } catch (e) {
        return [DEFAULT_PROFILE];
      }
    }

    function saveProfiles(list) {
      localStorage.setItem("irontune_profiles_v1", JSON.stringify(list));
    }

    // ---------- Visual Stick Component ----------
    function StickViz({ label, x, y, size = 160 }) {
      const radius = size / 2;
      const cx = radius;
      const cy = radius;
      const dotX = cx + x * (radius - 12);
      const dotY = cy + y * (radius - 12);
      return (
        <div className="flex flex-col items-center">
          <div className="text-xs uppercase tracking-wider text-zinc-400 mb-2">{label}</div>
          <svg width={size} height={size} className="rounded-2xl shadow border border-zinc-800 bg-zinc-900">
            <circle cx={cx} cy={cy} r={radius - 6} className="fill-zinc-950 stroke-zinc-800" strokeWidth="2" />
            <line x1={cx} y1={6} x2={cx} y2={size - 6} className="stroke-zinc-800" strokeWidth="1" />
            <line x1={6} y1={cy} x2={size - 6} y2={cy} className="stroke-zinc-800" strokeWidth="1" />
            <circle cx={dotX} cy={dotY} r={8} className="fill-white/90" />
          </svg>
          <div className="mt-1 text-xs text-zinc-500">
            X: {x.toFixed(3)} • Y: {y.toFixed(3)}
          </div>
        </div>
      );
    }

    // ---------- Trigger Bar ----------
    function TriggerBar({ label, v }) {
      const pct = Math.round(clamp01(v) * 100);
      return (
        <div className="w-full">
          <div className="flex justify-between text-xs text-zinc-400">
            <span>{label}</span>
            <span>{pct}%</span>
          </div>
          <div className="h-2 rounded bg-zinc-800 overflow-hidden">
            <div className="h-full w-full bg-white/90" style={{ width: pct + "%" }} />
          </div>
        </div>
      );
    }

    // ---------- Controller Layout Visual (neon) ----------
    function BtnLamp({ on, label }) {
      return (
        <div
          className={
            "px-2 py-1 rounded text-[10px] border " +
            (on
              ? "bg-cyan-300 text-zinc-900 border-cyan-300"
              : "border-zinc-700 text-zinc-400")
          }
        >
          {label}
        </div>
      );
    }

    function getControllerKind(pad) {
      if (!pad) return "generic";
      const id = pad.id.toLowerCase();

      if (id.includes("xbox") || id.includes("xinput") || id.includes("microsoft")) return "xbox";
      if (id.includes("edge")) return "dualsense_edge";

      if (id.includes("dualshock") || id.includes("ps4")) return "ds4";

      if (
        id.includes("dualsense") ||
        id.includes("playstation") ||
        (id.includes("wireless controller") && !id.includes("xbox"))
      ) {
        return "dualsense";
      }

      if (id.includes("switch") || id.includes("joy-con") || id.includes("pro controller"))
        return "switch";

      return "generic";
    }

    function ControllerLayoutPS({ pad, processed, special }) {
      const b = (i) => !!(pad && pad.buttons && pad.buttons[i] && pad.buttons[i].pressed);
      return (
        <div className="relative w-full max-w-xl mx-auto h-80 rounded-[2.2rem] border border-cyan-500/30 bg-zinc-950 shadow-[0_0_40px_rgba(34,211,238,0.25)] overflow-hidden">
          {/* Top triggers + bumpers */}
          <div className="absolute inset-x-6 top-3 flex justify-between text-[10px] text-cyan-200">
            <div className="flex flex-col gap-1 items-start">
              <TriggerBar label="L2" v={processed ? processed.lt : 0} />
              <BtnLamp on={b(4)} label="L1" />
            </div>
            <div className="flex flex-col gap-1 items-end">
              <TriggerBar label="R2" v={processed ? processed.rt : 0} />
              <BtnLamp on={b(5)} label="R1" />
            </div>
          </div>

          {/* Touchpad area */}
          <div
            className={
              "absolute left-1/2 top-[32%] -translate-x-1/2 w-40 h-16 rounded-2xl border " +
              (special.touch
                ? "border-cyan-300 bg-cyan-300/10 shadow-[0_0_25px_rgba(34,211,238,0.65)]"
                : "border-zinc-700 bg-zinc-900/80")
            }
          />

          {/* Share / Options buttons */}
          <div className="absolute left-1/2 top-[23%] -translate-x-1/2 flex gap-3 text-[10px]">
            <BtnLamp on={b(8)} label="Share" />
            <BtnLamp on={b(9)} label="Options" />
          </div>

          {/* Left grip: D-Pad + Left Stick */}
          <div className="absolute left-[10%] top-[38%] -translate-y-1/2">
            <div className="grid grid-cols-3 grid-rows-3 gap-1 mb-4">
              <div />
              <div className={"w-6 h-6 rounded " + (b(12) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div />
              <div className={"w-6 h-6 rounded " + (b(14) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div className="w-6 h-6" />
              <div className={"w-6 h-6 rounded " + (b(15) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div />
              <div className={"w-6 h-6 rounded " + (b(13) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div />
            </div>
            <div className="mt-2">
              <StickViz label="L" x={processed ? processed.lx : 0} y={processed ? processed.ly : 0} size={110} />
            </div>
          </div>

          {/* Right grip: Face buttons + Right Stick (PlayStation symbols) */}
          <div className="absolute right-[10%] top-[38%] -translate-y-1/2 flex flex-col items-center gap-4">
            <div className="grid grid-cols-3 grid-rows-3 gap-2 place-items-center">
              <div />
              <div className={"w-6 h-6 rounded-full " + (b(3) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div />
              <div className={"w-6 h-6 rounded-full " + (b(2) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div className={"w-6 h-6 rounded-full " + (b(1) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div />
              <div />
              <div className={"w-6 h-6 rounded-full " + (b(0) ? "bg-cyan-300" : "bg-zinc-800")} />
              <div />
            </div>
            <StickViz label="R" x={processed ? processed.rx : 0} y={processed ? processed.ry : 0} size={110} />
          </div>

          {/* PS / Home button */}
          <div className="absolute left-1/2 bottom-4 -translate-x-1/2 flex flex-col items-center gap-1">
            <div
              className={
                "w-7 h-7 rounded-full border flex items-center justify-center text-[10px] " +
                (special.home
                  ? "border-cyan-300 bg-cyan-300 text-zinc-900"
                  : "border-zinc-600 bg-zinc-900 text-zinc-300")
              }
            >
              PS
            </div>
            <div className="flex gap-2 text-[10px] text-zinc-400">
              <span>L3: {pad && pad.buttons[10] && pad.buttons[10].pressed ? "ON" : "OFF"}</span>
              <span>R3: {pad && pad.buttons[11] && pad.buttons[11].pressed ? "ON" : "OFF"}</span>
            </div>
          </div>
        </div>
      );
    }

    function ControllerLayoutXbox({ pad, processed }) {
      const b = (i) => !!(pad && pad.buttons && pad.buttons[i] && pad.buttons[i].pressed);
      return (
        <div className="relative w-full max-w-xl mx-auto h-80 rounded-[2.2rem] border border-emerald-500/30 bg-zinc-950 shadow-[0_0_40px_rgba(16,185,129,0.25)] overflow-hidden">
          {/* Top triggers + bumpers */}
          <div className="absolute inset-x-6 top-3 flex justify-between text-[10px] text-emerald-200">
            <div className="flex flex-col gap-1 items-start">
              <TriggerBar label="LT" v={processed ? processed.lt : 0} />
              <BtnLamp on={b(4)} label="LB" />
            </div>
            <div className="flex flex-col gap-1 items-end">
              <TriggerBar label="RT" v={processed ? processed.rt : 0} />
              <BtnLamp on={b(5)} label="RB" />
            </div>
          </div>

          {/* View / Menu buttons */}
          <div className="absolute left-1/2 top-[23%] -translate-x-1/2 flex gap-3 text-[10px]">
            <BtnLamp on={b(8)} label="View" />
            <BtnLamp on={b(9)} label="Menu" />
          </div>

          {/* Left grip */}
          <div className="absolute left-[10%] top-[38%] -translate-y-1/2">
            <div className="grid grid-cols-3 grid-rows-3 gap-1 mb-4">
              <div />
              <div className={"w-6 h-6 rounded " + (b(12) ? "bg-emerald-300" : "bg-zinc-800")} />
              <div />
              <div className={"w-6 h-6 rounded " + (b(14) ? "bg-emerald-300" : "bg-zinc-800")} />
              <div className="w-6 h-6" />
              <div className={"w-6 h-6 rounded " + (b(15) ? "bg-emerald-300" : "bg-zinc-800")} />
              <div />
              <div className={"w-6 h-6 rounded " + (b(13) ? "bg-emerald-300" : "bg-zinc-800")} />
              <div />
            </div>
            <div className="mt-2">
              <StickViz label="L" x={processed ? processed.lx : 0} y={processed ? processed.ly : 0} size={110} />
            </div>
          </div>

          {/* Right grip */}
          <div className="absolute right-[10%] top-[38%] -translate-y-1/2 flex flex-col items-center gap-4">
            <div className="grid grid-cols-3 grid-rows-3 gap-2 place-items-center text-[10px] font-semibold">
              <div />
              <div className={"w-6 h-6 rounded-full flex items-center justify-center " + (b(3) ? "bg-emerald-300 text-zinc-900" : "bg-zinc-800 text-emerald-200")}>Y</div>
              <div />
              <div className={"w-6 h-6 rounded-full flex items-center justify-center " + (b(2) ? "bg-emerald-300 text-zinc-900" : "bg-zinc-800 text-emerald-200")}>X</div>
              <div className={"w-6 h-6 rounded-full flex items-center justify-center " + (b(1) ? "bg-emerald-300 text-zinc-900" : "bg-zinc-800 text-emerald-200")}>B</div>
              <div />
              <div />
              <div className={"w-6 h-6 rounded-full flex items-center justify-center " + (b(0) ? "bg-emerald-300 text-zinc-900" : "bg-zinc-800 text-emerald-200")}>A</div>
              <div />
            </div>
            <StickViz label="R" x={processed ? processed.rx : 0} y={processed ? processed.ry : 0} size={110} />
          </div>

          {/* Xbox button */}
          <div className="absolute left-1/2 bottom-4 -translate-x-1/2 flex flex-col items-center gap-1">
            <div className="w-8 h-8 rounded-full border border-emerald-300 flex items-center justify-center text-[10px] bg-zinc-900 text-emerald-200">
              ⊗
            </div>
            <div className="flex gap-2 text-[10px] text-zinc-400">
              <span>L3: {pad && pad.buttons[10] && pad.buttons[10].pressed ? "ON" : "OFF"}</span>
              <span>R3: {pad && pad.buttons[11] && pad.buttons[11].pressed ? "ON" : "OFF"}</span>
            </div>
          </div>
        </div>
      );
    }

    function ControllerLayout({ pad, processed, special }) {
      const kind = getControllerKind(pad || undefined);
      return (
        <div className="space-y-2">
          <div className="flex items-center justify-between text-xs text-zinc-400">
            <span className="truncate max-w-[65%]">
              {pad ? pad.id : "Tiada controller dikesan"}
            </span>
            <span className="px-2 py-0.5 rounded-full border border-cyan-500/40 text-[10px] uppercase tracking-wide">
              {kind === "xbox"
                ? "Xbox Layout"
                : kind === "dualsense_edge"
                ? "DualSense Edge Layout"
                : kind === "ds4"
                ? "DualShock 4 Layout"
                : kind === "dualsense"
                ? "DualSense Layout"
                : kind === "switch"
                ? "Switch / Pro Layout"
                : "Generic Layout"}
            </span>
          </div>
          {kind === "xbox" ? (
            <ControllerLayoutXbox pad={pad} processed={processed} special={special} />
          ) : (
            <ControllerLayoutPS pad={pad} processed={processed} special={special} />
          )}
        </div>
      );
    }

    // ---------- WebHID (Advanced Raw) ----------
    async function requestHIDDevice() {
      if (!("hid" in navigator)) throw new Error("WebHID not supported in this browser.");
      const devices = await navigator.hid.requestDevice({
        filters: [
          { vendorId: 0x054c }, // Sony
          { vendorId: 0x045e }, // Microsoft
          { vendorId: 0x057e }, // Nintendo
        ],
      });
      return devices && devices[0];
    }

    function bytesToHex(buf) {
      const out = [];
      for (let i = 0; i < buf.byteLength; i++) {
        const b = buf.getUint8(i).toString(16).padStart(2, "0");
        out.push(b);
      }
      return out.join(" ");
    }

    // ---------- Main App ----------
    function IronTuneApp() {
      const [connectedIndex, setConnectedIndex] = useState(null);
      const [pads, setPads] = useState([]);
      const [profiles, setProfiles] = useState(loadProfiles());
      const [activeProfileName, setActiveProfileName] = useState(profiles[0] ? profiles[0].name : "Default");

      const activeProfile = useMemo(
        () => profiles.find((p) => p.name === activeProfileName) || profiles[0],
        [profiles, activeProfileName]
      );

      const [leftDZ, setLeftDZ] = useState(activeProfile.settings.left.deadzone);
      const [rightDZ, setRightDZ] = useState(activeProfile.settings.right.deadzone);
      const [leftCurve, setLeftCurve] = useState(activeProfile.settings.left.curve);
      const [rightCurve, setRightCurve] = useState(activeProfile.settings.right.curve);
      const [trigs, setTrigs] = useState(activeProfile.settings.triggers);

      const [rawHIDLog, setRawHIDLog] = useState([]);
      const hidDeviceRef = useRef(null);
      const [toast, setToast] = useState("");
      const [special, setSpecial] = useState({ home: false, touch: false });

      // Sync when profile change
      useEffect(() => {
        setLeftDZ(activeProfile.settings.left.deadzone);
        setRightDZ(activeProfile.settings.right.deadzone);
        setLeftCurve(activeProfile.settings.left.curve);
        setRightCurve(activeProfile.settings.right.curve);
        setTrigs(activeProfile.settings.triggers);
      }, [activeProfile]);

      // Gamepad connection events
      useEffect(() => {
        function onConnect(e) {
          setConnectedIndex(e.gamepad.index);
        }
        function onDisconnect() {
          setConnectedIndex(null);
        }
        window.addEventListener("gamepadconnected", onConnect);
        window.addEventListener("gamepaddisconnected", onDisconnect);
        return () => {
          window.removeEventListener("gamepadconnected", onConnect);
          window.removeEventListener("gamepaddisconnected", onDisconnect);
        };
      }, []);

      // Poll pads
      useEffect(() => {
        let raf;
        const loop = () => {
          const arr = navigator.getGamepads
            ? Array.from(navigator.getGamepads()).filter(Boolean)
            : [];
          setPads(arr);
          raf = requestAnimationFrame(loop);
        };
        raf = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(raf);
      }, []);

      const pad = useMemo(() => {
        if (connectedIndex != null) {
          return pads.find((p) => p.index === connectedIndex) || pads[0];
        }
        return pads[0];
      }, [pads, connectedIndex]);

      const processed = useMemo(() => {
        if (!pad) return null;
        const ax = pad.axes || [];
        let lx = ax[0] || 0;
        let ly = ax[1] || 0;
        let rx = ax[2] || 0;
        let ry = ax[3] || 0;

        const L = applyDeadzone(lx, ly, leftDZ);
        const R = applyDeadzone(rx, ry, rightDZ);

        const lx2 = applyCurve(L.x, leftCurve);
        const ly2 = applyCurve(L.y, leftCurve);
        const rx2 = applyCurve(R.x, rightCurve);
        const ry2 = applyCurve(R.y, rightCurve);

        const ltRaw = (pad.buttons[6] && pad.buttons[6].value) || 0;
        const rtRaw = (pad.buttons[7] && pad.buttons[7].value) || 0;

        const norm = (v, min, max) =>
          clamp01((v - min) / Math.max(0.0001, max - min));

        const lt = norm(ltRaw, trigs.l2Min, trigs.l2Max);
        const rt = norm(rtRaw, trigs.r2Min, trigs.r2Max);

        const homeIdx = pad.buttons.length > 16 ? 16 : -1;
        const touchIdx = pad.buttons.length > 17 ? 17 : -1;
        setSpecial({
          home: homeIdx >= 0 ? !!pad.buttons[homeIdx].pressed : false,
          touch: touchIdx >= 0 ? !!pad.buttons[touchIdx].pressed : false,
        });

        return { lx: lx2, ly: ly2, rx: rx2, ry: ry2, lt, rt };
      }, [pad, leftDZ, rightDZ, leftCurve, rightCurve, trigs]);

      function saveCurrentProfile(asName) {
        const name = (asName && asName.trim()) || activeProfileName;
        const updated = {
          name,
          createdAt: activeProfile.createdAt || new Date().toISOString(),
          settings: {
            left: { deadzone: leftDZ, curve: leftCurve },
            right: { deadzone: rightDZ, curve: rightCurve },
            triggers: { ...trigs },
          },
        };
        let list = profiles.filter((p) => p.name !== name);
        list = [updated, ...list];
        setProfiles(list);
        saveProfiles(list);
        setToast('Profil "' + name + '" berjaya disimpan ✔');
        setTimeout(() => setToast(""), 2000);
      }

      function newProfile() {
        const base = "Profile " + (profiles.length + 1);
        const name = prompt("Nama profil baharu:", base) || base;
        const p = {
          name,
          createdAt: new Date().toISOString(),
          settings: JSON.parse(JSON.stringify(DEFAULT_PROFILE.settings)),
        };
        const list = [p, ...profiles];
        setProfiles(list);
        saveProfiles(list);
        setActiveProfileName(name);
      }

      function deleteProfile(n) {
        if (!confirm('Padam profil "' + n + '"?')) return;
        const list = profiles.filter((p) => p.name !== n);
        const finalList = list.length ? list : [DEFAULT_PROFILE];
        setProfiles(finalList);
        saveProfiles(finalList);
        if (activeProfileName === n) setActiveProfileName(finalList[0].name);
      }

      function exportProfiles() {
        const blob = new Blob([JSON.stringify(profiles, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "IronTune_Profiles.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importProfiles(evt) {
        const f = evt.target.files && evt.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const arr = JSON.parse(String(reader.result));
            if (!Array.isArray(arr)) throw new Error("Fail bukan senarai profil");
            setProfiles(arr);
            saveProfiles(arr);
            setActiveProfileName(arr[0] && arr[0].name ? arr[0].name : "Default");
          } catch (e) {
            alert("Gagal import: " + (e.message || e));
          }
        };
        reader.readAsText(f);
      }

      async function connectHID() {
        try {
          const dev = await requestHIDDevice();
          if (!dev) return;
          await dev.open();
          hidDeviceRef.current = dev;
          dev.addEventListener("inputreport", (e) => {
            const view = new DataView(e.data.buffer);
            const hex = bytesToHex(view);
            setRawHIDLog((prev) => [
              new Date().toLocaleTimeString() +
                " • reportId=" +
                e.reportId +
                " • " +
                hex,
              ...prev.slice(0, 100),
            ]);
          });
        } catch (e) {
          alert(e.message || String(e));
        }
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-zinc-950 via-zinc-900 to-zinc-950 text-zinc-100 p-6">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
              <div>
                <h1 className="text-3xl md:text-4xl font-semibold tracking-tight text-cyan-300 drop-shadow-[0_0_10px_rgba(34,211,238,0.8)]">
                  IronTune
                  <span className="text-zinc-400"> — Controller Calibration Hub</span>
                </h1>
                <p className="text-zinc-400 mt-1">
                  by <span className="font-medium">Iron Gamers</span> • Web-based tester &amp; calibration (DualSense / DS4 /
                  Xbox Controller)
                </p>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={newProfile}
                  className="px-3 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700"
                >
                  Profil Baharu
                </button>
                <button
                  onClick={() => saveCurrentProfile()}
                  className="px-3 py-2 rounded-xl bg-white text-zinc-900 hover:opacity-90"
                >
                  Simpan Profil
                </button>
              </div>
            </div>

            {/* Top Controls */}
            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <div className="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/60">
                <div className="text-sm text-zinc-400">Gamepad</div>
                <div className="mt-1 text-lg font-medium">{pad ? pad.id : "Tiada controller dikesan"}</div>
                <div className="text-xs text-zinc-500">
                  Status: {pad ? (pad.connected ? "Connected" : "Disconnected") : "—"}
                </div>
                <div className="mt-3 flex gap-2">
                  <button
                    onClick={() =>
                      alert("Tip: Tekan sebarang butang pada controller untuk trigger pengesanan Gamepad API.")
                    }
                    className="px-3 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700"
                  >
                    Detect Controller
                  </button>
                  <button
                    onClick={connectHID}
                    className="px-3 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700"
                  >
                    Advanced (WebHID Raw)
                  </button>
                </div>
              </div>

              <div className="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/60">
                <div className="text-sm text-zinc-400">Profil Aktif</div>
                <select
                  className="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2"
                  value={activeProfileName}
                  onChange={(e) => setActiveProfileName(e.target.value)}
                >
                  {profiles.map((p) => (
                    <option key={p.name} value={p.name}>
                      {p.name}
                    </option>
                  ))}
                </select>
                <div className="mt-2 flex gap-2">
                  <button
                    onClick={() => {
                      const name = prompt("Simpan sebagai (Save As):", activeProfileName + " Copy");
                      if (name) saveCurrentProfile(name);
                    }}
                    className="px-3 py-2 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700"
                  >
                    Save As
                  </button>
                  <button
                    onClick={() => deleteProfile(activeProfileName)}
                    className="px-3 py-2 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700"
                  >
                    Padam
                  </button>
                </div>
              </div>

              <div className="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/60">
                <div className="text-sm text-zinc-400">Import / Export</div>
                <div className="flex gap-2 mt-2">
                  <button
                    onClick={exportProfiles}
                    className="px-3 py-2 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700"
                  >
                    Export JSON
                  </button>
                  <label className="px-3 py-2 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 cursor-pointer">
                    Import JSON
                    <input type="file" accept="application/json" className="hidden" onChange={importProfiles} />
                  </label>
                </div>
                <div className="text-[11px] text-zinc-500 mt-2">
                  Fail disimpan tempatan (localStorage). Sesuai untuk kegunaan kedai.
                </div>
              </div>
            </div>

            {/* Calibration + Visuals */}
            <div className="grid lg:grid-cols-2 gap-6">
              {/* Left Panel: Visual Tester */}
              <div className="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/60">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-semibold text-cyan-300 drop-shadow-[0_0_8px_rgba(34,211,238,0.7)]">
                    Controller Tester
                  </h2>
                  <div className="text-xs text-zinc-500">Polling via Gamepad API</div>
                </div>
                <ControllerLayout pad={pad} processed={processed} special={special} />
              </div>

              {/* Right Panel: Calibration Controls */}
              <div className="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/60">
                <h2 className="text-xl font-semibold mb-4">Calibration</h2>
                <div className="grid sm:grid-cols-2 gap-6">
                  <div>
                    <div className="text-sm text-zinc-400">
                      Left Stick Deadzone: {leftDZ.toFixed(2)}
                    </div>
                    <input
                      type="range"
                      min={0}
                      max={0.3}
                      step={0.005}
                      value={leftDZ}
                      onChange={(e) => setLeftDZ(parseFloat(e.target.value))}
                      className="w-full"
                    />
                    <div className="mt-2 text-sm text-zinc-400">Left Stick Curve</div>
                    <select
                      className="mt-1 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2"
                      value={leftCurve}
                      onChange={(e)
