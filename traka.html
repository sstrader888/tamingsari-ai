<!-- Full updated HTML with fixes for graph, currency dropdown, English translation, AI CSV review and manual trade form -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRAKA Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .btn-primary { background-color: #2563eb; transition: background-color 0.3s; }
    .btn-primary:hover { background-color: #1e40af; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-300">
  <div class="max-w-4xl mx-auto px-4">
    <div class="flex justify-between items-center py-4">
      <span id="userNameDisplay" class="text-sm font-medium text-blue-700">Pengguna</span>
      <div class="flex gap-2 items-center">
        <button id="logoutBtn" class="text-sm border rounded px-2 py-1 bg-red-600 text-white hover:bg-red-700">Logout</button>
        <select id="langSwitcher" class="text-sm border rounded px-2 py-1">
          <option value="ms">Bahasa Melayu</option>
          <option value="en">English (UK)</option>
        </select>
      </div>
    </div>

    <header class="bg-white shadow-md rounded-2xl p-6 mb-6 flex items-center gap-4">
      <div class="bg-blue-600 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center text-xl">T</div>
      <div>
        <h1 class="text-3xl font-bold text-gray-800" id="dashboardTitle">TRAKA Dashboard</h1>
        <p class="text-sm text-gray-500" id="greetingText">Assalamualaikum, <span id="greetName">Pengguna</span>. Jejak perjalanan trading anda secara berdisiplin.</p>
      </div>
    </header>

    <section class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-3xl mb-2">ðŸ“Š</div>
        <h2 class="text-sm font-semibold" id="totalTradesLabel">Jumlah Trade</h2>
        <p id="totalTrades" class="text-xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-3xl mb-2">ðŸŽ¯</div>
        <h2 class="text-sm font-semibold" id="winRateLabel">Win Rate</h2>
        <p id="winRate" class="text-xl font-bold text-green-600">0%</p>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-3xl mb-2">ðŸ’°</div>
        <h2 class="text-sm font-semibold" id="monthlyProfitLabel">Profit Bulanan</h2>
        <select id="currencySelector" class="text-xs mt-1 mb-2 border rounded px-2 py-1">
          <option value="MYR">MYR</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="JPY">JPY</option>
          <option value="SGD">SGD</option>
        </select>
        <p id="monthlyProfit" class="text-xl font-bold text-yellow-600" data-value="0">RM0</p>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-3xl mb-2">ðŸ§ </div>
        <h2 class="text-sm font-semibold" id="aiReviewLabel">AI Ulasan</h2>
        <p id="aiSummary" class="text-sm italic text-gray-700">Belum dianalisis.</p>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-4" id="chartTitle">Graf Prestasi Harian</h2>
      <canvas id="performanceChart" height="200"></canvas>
    </section>

    <section class="bg-white p-6 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-4" id="csvTitle">Muat Naik Fail CSV dari MT5</h2>
      <form class="flex flex-col md:flex-row gap-4 mb-4">
        <input type="file" accept=".csv" id="csvUpload" class="p-2 border rounded w-full" />
        <button type="button" onclick="parseCSVFile()" class="btn-primary px-4 py-2 text-white rounded" id="uploadBtn">Upload & Analisis CSV</button>
      </form>
    </section>

    <section class="bg-white p-6 rounded-2xl shadow mb-10">
      <h2 class="text-lg font-semibold mb-4" id="manualTitle">Tambah Trade Manual</h2>
      <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input class="p-2 border rounded" type="date" required />
        <input class="p-2 border rounded" type="text" placeholder="Pair (cth: XAU/USD)" required />
        <select class="p-2 border rounded" required>
          <option value="">Pilih Setup</option>
          <option value="Dominan Candle">Dominan Candle</option>
          <option value="Breakout">Breakout</option>
          <option value="Taming Sari">Taming Sari</option>
        </select>
        <input class="p-2 border rounded" type="number" placeholder="Profit/Loss (RM)" required />
        <select class="p-2 border rounded" required>
          <option value="">Emosi Sebelum Trade</option>
          <option value="Tenang">Tenang</option>
          <option value="Takut">Takut</option>
          <option value="Tamak">Tamak</option>
        </select>
        <input class="p-2 border rounded" type="text" placeholder="Nota Ringkas (optional)" />
        <input class="p-2 border rounded" type="file" accept="image/*" />
        <button class="col-span-1 md:col-span-2 btn-primary text-white py-2 rounded">Simpan Trade</button>
      </form>
    </section>
  </div>

  <script>
    const userName = localStorage.getItem("userName") || "Pengguna";
    document.getElementById("userNameDisplay").textContent = userName;
    document.getElementById("greetName").textContent = userName;
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("userName");
      window.location.href = 'traka-login.html';
    });

    const langSwitcher = document.getElementById("langSwitcher");
    const i18n = {
      ms: {
        greeting: `Assalamualaikum, ${userName}. Jejak perjalanan trading anda secara berdisiplin.`,
        totalTrades: "Jumlah Trade",
        winRate: "Win Rate",
        profitLabel: "Profit Bulanan",
        aiReview: "AI Ulasan",
        aiStatus: "Belum dianalisis.",
        chartTitle: "Graf Prestasi Harian",
        csvTitle: "Muat Naik Fail CSV dari MT5",
        manualTitle: "Tambah Trade Manual",
        uploadBtn: "Upload & Analisis CSV"
      },
      en: {
        greeting: `Welcome, ${userName}. Track your trading journey with discipline.`,
        totalTrades: "Total Trades",
        winRate: "Win Rate",
        profitLabel: "Monthly Profit",
        aiReview: "AI Summary",
        aiStatus: "Not analyzed yet.",
        chartTitle: "Performance Chart",
        csvTitle: "Upload CSV File from MT5",
        manualTitle: "Add Manual Trade",
        uploadBtn: "Upload & Analyze CSV"
      }
    };

    langSwitcher.addEventListener("change", function () {
      const lang = this.value;
      const t = i18n[lang];
      document.getElementById("greetingText").textContent = t.greeting;
      document.getElementById("totalTradesLabel").textContent = t.totalTrades;
      document.getElementById("winRateLabel").textContent = t.winRate;
      document.getElementById("monthlyProfitLabel").textContent = t.profitLabel;
      document.getElementById("aiReviewLabel").textContent = t.aiReview;
      document.getElementById("chartTitle").textContent = t.chartTitle;
      document.getElementById("csvTitle").textContent = t.csvTitle;
      document.getElementById("manualTitle").textContent = t.manualTitle;
      document.getElementById("uploadBtn").textContent = t.uploadBtn;
      if (document.getElementById("aiSummary").textContent === i18n.ms.aiStatus || document.getElementById("aiSummary").textContent === i18n.en.aiStatus) {
        document.getElementById("aiSummary").textContent = t.aiStatus;
      }
    });

    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu', 'Ahad'],
        datasets: [{
          label: 'Profit Harian (RM)',
          data: [50, -20, 80, 100, -30, 40, 90],
          borderColor: 'rgba(59, 130, 246, 1)',
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    document.getElementById("currencySelector").addEventListener("change", function () {
      const selected = this.value;
      const el = document.getElementById("monthlyProfit");
      const val = parseFloat(el.getAttribute("data-value")) || 0;
      const symbols = { MYR: "RM", USD: "$", EUR: "â‚¬", JPY: "Â¥", SGD: "S$" };
      el.textContent = symbols[selected] + val.toFixed(2);
    });

    function parseCSVFile() {
      const fileInput = document.getElementById('csvUpload');
      const file = fileInput.files[0];
      if (!file) return alert('Sila pilih fail CSV terlebih dahulu.');

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const rows = text.split(/\n/).filter(row => row.trim() !== '');
        let trades = 0, wins = 0, profit = 0;

        rows.forEach((row, i) => {
          const cols = row.split(',');
          const pl = parseFloat(cols[9]) || 0;
          profit += pl;
          if (pl > 0) wins++;
          if (i > 0) trades++;
        });

        const rate = trades ? Math.round((wins / trades) * 100) : 0;
        document.getElementById("totalTrades").textContent = trades;
        document.getElementById("winRate").textContent = rate + "%";
        document.getElementById("monthlyProfit").setAttribute("data-value", profit);
        document.getElementById("monthlyProfit").textContent = 'RM' + profit.toFixed(2);
        document.getElementById("aiSummary").textContent = `Daripada ${trades} trade, anda menang ${wins} (${rate}%). Prestasi bulan ini ${profit >= 0 ? 'positif' : 'negatif'}.`;
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
