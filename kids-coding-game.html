<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NEON DODGE: STABLE</title>
  <style>
    /* RESET */
    * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0; padding: 0;
      background: #000;
      font-family: 'Segoe UI', sans-serif; /* Guna font biasa supaya tak error */
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100vw;
    }

    /* CONTAINER GAME */
    #gameContainer {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 500px; /* Limit lebar untuk PC */
      background: linear-gradient(to bottom, #1a0b2e, #000000);
      overflow: hidden;
      border: 1px solid #333;
    }

    canvas { display: block; width: 100%; height: 100%; z-index: 1; }

    /* UI SCORE */
    .hud {
      position: absolute; top: 20px; width: 100%;
      display: flex; justify-content: space-between; padding: 0 20px;
      z-index: 10; pointer-events: none;
    }
    .score-box { color: #fff; font-size: 14px; font-weight: bold; }
    .score-val { font-size: 20px; color: #00f3ff; display:block; }

    /* BUTTON DASH (MOBILE) */
    .dash-wrapper {
      position: absolute; bottom: 30px; width: 100%;
      display: flex; justify-content: center; z-index: 20; pointer-events: auto;
    }
    .dash-btn {
      background: rgba(255, 0, 85, 0.2); border: 2px solid #ff0055;
      color: #fff; padding: 15px 40px; border-radius: 8px;
      font-weight: 900; font-size: 16px; letter-spacing: 1px;
      text-transform: uppercase;
      box-shadow: 0 0 15px rgba(255, 0, 85, 0.5);
    }
    .dash-btn:active { background: #ff0055; transform: scale(0.95); }

    /* MENU OVERLAY */
    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 999; transition: opacity 0.3s;
    }
    .hidden { opacity: 0; pointer-events: none; visibility: hidden; }

    h1 { color: #00f3ff; font-size: 36px; margin: 0; text-align: center; text-shadow: 0 0 20px #00f3ff; font-style: italic; }
    p { color: #aaa; text-align: center; font-size: 12px; margin-bottom: 20px; line-height: 1.5; }
    
    .btn-start {
      background: #00f3ff; color: #000; border: none; padding: 15px 50px;
      font-size: 18px; font-weight: 900; cursor: pointer; border-radius: 50px;
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
    }

    /* DEBUG ERROR BOX (Kalau ada error, kotak merah keluar) */
    #errorBox {
      position: absolute; top: 0; left: 0; width: 100%; background: red; color: white;
      padding: 10px; font-size: 12px; z-index: 9999; display: none;
    }
  </style>
</head>
<body>

<div id="errorBox"></div>

<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>
  
  <div class="hud">
    <div class="score-box">SCORE<span class="score-val" id="scoreEl">0</span></div>
    <div class="score-box" style="text-align:right">BEST<span class="score-val" id="bestEl">0</span></div>
  </div>

  <div class="dash-wrapper">
    <button class="dash-btn" id="btnDash">âš¡ BOOST</button>
  </div>
  
  <div class="overlay" id="menuOverlay">
    <h1>NEON DODGE</h1>
    <p>MOBILE: TAP KIRI/KANAN SKRIN<br>PC: GUNA ARROW KEYS</p>
    <button class="btn-start" id="startBtn">START GAME</button>
  </div>
</div>

<script>
  // --- SYSTEM ERROR CATCHER ---
  window.onerror = function(msg, url, line) {
    const box = document.getElementById('errorBox');
    box.style.display = 'block';
    box.innerText = "ERROR: " + msg + " (Line: " + line + ")";
    return false;
  };

  // --- SETUP ---
  const container = document.getElementById('gameContainer');
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('scoreEl');
  const bestEl = document.getElementById('bestEl');
  const overlay = document.getElementById('menuOverlay');
  const startBtn = document.getElementById('startBtn');
  const btnDash = document.getElementById('btnDash');

  // AUDIO (SAFE MODE)
  let actx = null;
  function initAudio() {
    try {
      if (!actx) { actx = new (window.AudioContext || window.webkitAudioContext)(); }
      if (actx.state === 'suspended') actx.resume();
    } catch(e) { console.log("Audio not supported"); }
  }

  function playSound(type) {
    if (!actx) return;
    try {
      const osc = actx.createOscillator();
      const gain = actx.createGain();
      osc.connect(gain); gain.connect(actx.destination);
      const now = actx.currentTime;
      
      if (type === 'hit') {
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.exponentialRampToValueAtTime(10, now+0.3);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.linearRampToValueAtTime(0, now+0.3);
      } else {
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(800, now+0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now+0.1);
      }
      osc.start(now); osc.stop(now+0.3);
    } catch(e) {}
  }

  // RESIZE
  function resize() {
    if(container) {
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
    }
  }
  window.addEventListener('resize', resize);
  setTimeout(resize, 100); // Double check size

  // VARIABLES
  let player = { x: 0, y: 0, trail: [] };
  let rocks = [];
  let score = 0;
  let highScore = localStorage.getItem('neonBest') || 0;
  let running = false;
  let speed = 1;
  let frame = 0;
  let gridOffset = 0;
  bestEl.innerText = highScore;

  const keys = { left: false, right: false, dash: false };

  function startGame() {
    initAudio();
    resize();
    player.x = canvas.width / 2;
    player.y = canvas.height - 100;
    player.trail = [];
    rocks = [];
    score = 0;
    speed = 1;
    running = true;
    scoreEl.innerText = 0;
    overlay.classList.add('hidden');
    loop();
  }

  function update() {
    if (!running) return;
    frame++;
    gridOffset += 2 + (keys.dash ? 5:0);
    if(gridOffset > 40) gridOffset=0;

    let moveSpeed = 6;
    if (keys.dash) moveSpeed = 12;

    // Trail logic
    if (frame % 3 === 0) {
      player.trail.push({x: player.x, y: player.y});
      if (player.trail.length > 5) player.trail.shift();
    }

    if (keys.left) player.x -= moveSpeed;
    if (keys.right) player.x += moveSpeed;

    // Clamp
    if (player.x < 15) player.x = 15;
    if (player.x > canvas.width - 15) player.x = canvas.width - 15;

    // Spawn Rocks
    if (Math.random() < 0.03 * speed) {
      rocks.push({
        x: Math.random() * canvas.width,
        y: -50,
        s: 20 + Math.random() * 30,
        vy: (4 + Math.random() * 2) * speed,
        rot: Math.random()
      });
    }

    // Rocks update
    for (let i = rocks.length - 1; i >= 0; i--) {
      let r = rocks[i];
      r.y += r.vy; r.rot += 0.05;
      
      let dx = player.x - r.x;
      let dy = player.y - r.y;
      if (Math.sqrt(dx*dx + dy*dy) < (r.s/2 + 15)) {
        gameOver();
      }

      if (r.y > canvas.height + 50) {
        rocks.splice(i, 1);
        score += 10;
        scoreEl.innerText = score;
        speed += 0.002;
      }
    }
  }

  function draw() {
    ctx.fillStyle = '#050011';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // GRID 3D
    ctx.save();
    ctx.strokeStyle = 'rgba(200, 0, 255, 0.2)';
    ctx.lineWidth = 1;
    let cx = canvas.width/2;
    // Garis menegak
    for(let i=-5; i<=5; i++) {
       ctx.beginPath(); 
       ctx.moveTo(cx + (i*50), 0); 
       ctx.lineTo(cx + (i*150), canvas.height); 
       ctx.stroke();
    }
    // Garis melintang
    for(let i=0; i<canvas.height; i+=40) {
       let y = i + gridOffset;
       if(y>canvas.height) y-=canvas.height;
       ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
    }
    ctx.restore();

    if (running) {
      // Trail
      if(player.trail.length>0){
        ctx.strokeStyle = 'rgba(0,243,255,0.5)';
        ctx.lineWidth = 10;
        ctx.beginPath();
        ctx.moveTo(player.trail[0].x, player.trail[0].y);
        for(let t of player.trail) ctx.lineTo(t.x, t.y);
        ctx.lineTo(player.x, player.y);
        ctx.stroke();
      }

      // Player
      ctx.save(); ctx.translate(player.x, player.y);
      ctx.fillStyle = keys.dash ? '#fff' : '#00f3ff';
      ctx.shadowBlur = 15; ctx.shadowColor = '#00f3ff';
      ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(15, 20); ctx.lineTo(0, 10); ctx.lineTo(-15, 20); ctx.fill();
      ctx.restore();

      // Rocks
      ctx.shadowBlur = 10; ctx.shadowColor = '#ff0055';
      ctx.strokeStyle = '#ff0055';
      rocks.forEach(r => {
        ctx.save(); ctx.translate(r.x, r.y); ctx.rotate(r.rot);
        ctx.strokeRect(-r.s/2, -r.s/2, r.s, r.s);
        ctx.restore();
      });
    }
    requestAnimationFrame(loop);
  }

  function loop() {
    update(); draw(); if(running) requestAnimationFrame(loop);
  }

  function gameOver() {
    running = false; playSound('hit');
    if (score > highScore) { highScore = score; localStorage.setItem('neonBest', highScore); bestEl.innerText = highScore; }
    overlay.classList.remove('hidden');
    document.querySelector('h1').innerText = "GAME OVER";
    startBtn.innerText = "RETRY";
  }

  // CONTROLS
  // Touch Zones (Kiri / Kanan Skrin)
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    for(let i=0; i<e.touches.length; i++) {
      if(e.touches[i].clientX < canvas.width/2) keys.left=true; else keys.right=true;
    }
  });
  canvas.addEventListener('touchend', (e) => {
    e.preventDefault(); keys.left=false; keys.right=false;
  });
  
  // Mouse (PC Test)
  canvas.addEventListener('mousedown', (e) => {
     if(e.clientX < canvas.width/2) keys.left=true; else keys.right=true;
  });
  canvas.addEventListener('mouseup', () => { keys.left=false; keys.right=false; });

  // Dash Button
  btnDash.addEventListener('touchstart', (e) => { e.preventDefault(); keys.dash=true; });
  btnDash.addEventListener('touchend', (e) => { e.preventDefault(); keys.dash=false; });
  btnDash.addEventListener('mousedown', () => keys.dash=true);
  btnDash.addEventListener('mouseup', () => keys.dash=false);

  // Keyboard
  window.addEventListener('keydown', (e) => {
    if(e.key==='ArrowLeft') keys.left=true;
    if(e.key==='ArrowRight') keys.right=true;
    if(e.code==='Space') keys.dash=true;
    if(!running && e.code==='Space') startGame();
  });
  window.addEventListener('keyup', (e) => {
    if(e.key==='ArrowLeft') keys.left=false;
    if(e.key==='ArrowRight') keys.right=false;
    if(e.code==='Space') keys.dash=false;
  });

  // Start Button
  startBtn.addEventListener('click', startGame);
  startBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startGame(); });

  loop(); // Init background
</script>
</body>
</html>
