<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NEON DODGE: MOBILE FIX</title>
  <style>
    /* RESET CSS UNTUK MOBILE */
    * {
      box-sizing: border-box;
      touch-action: none; /* Halang zoom & scroll */
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      position: fixed; /* Kunci screen supaya tak boleh scroll */
      width: 100%;
      height: 100%;
    }

    /* CANVAS BACKGROUND */
    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* SCOREBOARD (HUD) */
    .hud {
      position: absolute;
      top: 40px; /* Jarak dari atas */
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 25px;
      z-index: 10;
      pointer-events: none;
    }

    .score-box {
      color: #fff;
      font-size: 18px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 10px;
    }
    .score-box span { color: #00f3ff; }

    /* DASH BUTTON (TERAPUNG) */
    .dash-wrapper {
      position: absolute;
      bottom: 40px;
      left: 0; 
      width: 100%;
      display: flex;
      justify-content: center;
      z-index: 20;
      pointer-events: auto;
    }

    .dash-btn {
      background: rgba(255, 0, 85, 0.2); /* Lutsinar */
      border: 2px solid #ff0055;
      color: #fff;
      padding: 15px 60px; /* Button besar */
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      box-shadow: 0 0 15px rgba(255, 0, 85, 0.4);
      transition: transform 0.1s;
    }
    
    .dash-btn:active {
      background: #ff0055;
      transform: scale(0.95);
    }

    /* MENU OVERLAY (PALING ATAS) */
    .overlay {
      position: fixed; /* Guna fixed supaya sentiasa atas */
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(5, 5, 16, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999; /* Z-Index paling tinggi */
      transition: opacity 0.3s;
    }
    
    .hidden { 
      opacity: 0; 
      pointer-events: none; 
      visibility: hidden; /* Pastikan betul-betul hilang */
    }

    h1 {
      color: #00f3ff;
      font-style: italic;
      font-size: 42px;
      margin: 0 0 10px 0;
      text-align: center;
      text-shadow: 0 0 25px #00f3ff;
    }

    p { color: #ccc; text-align: center; margin-bottom: 30px; line-height: 1.6; padding: 0 20px; }

    /* BUTTON PLAY YANG DIBAIKI */
    .btn-start {
      background: linear-gradient(135deg, #00f3ff, #00c3cc);
      color: #000;
      border: none;
      padding: 18px 60px;
      font-size: 22px;
      font-weight: 900;
      border-radius: 50px;
      box-shadow: 0 0 30px rgba(0, 243, 255, 0.4);
      cursor: pointer;
      position: relative;
      z-index: 1000; /* Lebih tinggi dari overlay */
    }
    
    .btn-start:active { transform: scale(0.95); }

    /* TOUCH ZONES */
    .touch-zone {
      position: absolute;
      top: 0;
      height: 100%;
      width: 50%;
      z-index: 5;
      /* background: rgba(255,0,0,0.1); Debug: Turn on to see zones */
    }
    #zone-left { left: 0; }
    #zone-right { right: 0; }

  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>

  <div id="zone-left" class="touch-zone"></div>
  <div id="zone-right" class="touch-zone"></div>

  <div class="hud">
    <div class="score-box">SCORE: <span id="scoreEl">0</span></div>
    <div class="score-box">BEST: <span id="bestEl">0</span></div>
  </div>

  <div class="dash-wrapper">
    <button class="dash-btn" id="btnDash">‚ö° DASH</button>
  </div>

  <div class="overlay" id="menuOverlay">
    <h1>NEON DODGE</h1>
    <p>
      TAP KIRI skrin = Gerak Kiri<br>
      TAP KANAN skrin = Gerak Kanan<br>
      Elak blok merah!
    </p>
    <button class="btn-start" id="startBtn">‚ñ∂Ô∏è PLAY NOW</button>
  </div>

<script>
  // --- SETUP ---
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('scoreEl');
  const bestEl = document.getElementById('bestEl');
  const overlay = document.getElementById('menuOverlay');
  const startBtn = document.getElementById('startBtn');
  const btnDash = document.getElementById('btnDash');

  // Audio Context (Lazy Load)
  let actx = null;

  function initAudio() {
    if (!actx) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      actx = new AudioContext();
    }
    if (actx.state === 'suspended') {
      actx.resume();
    }
  }

  function playTone(type) {
    if (!actx) return; // Kalau audio tak start, jangan error
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.connect(gain);
    gain.connect(actx.destination);
    const now = actx.currentTime;

    if (type === 'hit') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(200, now);
      osc.frequency.exponentialRampToValueAtTime(10, now+0.3);
      gain.gain.setValueAtTime(0.3, now);
      gain.gain.linearRampToValueAtTime(0, now+0.3);
    } else {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(400, now);
      osc.frequency.exponentialRampToValueAtTime(800, now+0.1);
      gain.gain.setValueAtTime(0.1, now);
      gain.gain.linearRampToValueAtTime(0, now+0.1);
    }
    osc.start(now); osc.stop(now+0.3);
  }

  // --- RESIZE ---
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // --- GAME STATE ---
  let player = { x: 0, y: 0, w: 30, h: 40, vx: 0 };
  let rocks = [];
  let stars = [];
  let score = 0;
  let highScore = localStorage.getItem('neonBest') || 0;
  let running = false;
  let speed = 1;
  bestEl.innerText = highScore;

  // Init Stars
  for(let i=0; i<50; i++) stars.push({x:Math.random(), y:Math.random(), s:Math.random()*2});

  // --- CORE FUNCTIONS ---
  function startGame() {
    console.log("Game Starting..."); // Debug
    initAudio(); // Start audio bila user click
    playTone('start');
    
    // Reset Variables
    player.x = canvas.width / 2;
    player.y = canvas.height - 150;
    rocks = [];
    score = 0;
    speed = 1;
    running = true;
    scoreEl.innerText = 0;

    // Hide UI
    overlay.classList.add('hidden');
    
    // Start Loop
    loop();
  }

  // --- LOOP ---
  function update() {
    if (!running) return;

    // Player Move
    let moveSpeed = 6;
    if (keys.dash) moveSpeed = 12;

    if (keys.left) player.x -= moveSpeed;
    if (keys.right) player.x += moveSpeed;

    // Clamp
    if (player.x < 15) player.x = 15;
    if (player.x > canvas.width - 15) player.x = canvas.width - 15;

    // Spawn Rocks
    if (Math.random() < 0.02 * speed) {
      rocks.push({
        x: Math.random() * canvas.width,
        y: -50,
        s: 20 + Math.random() * 30,
        vy: (3 + Math.random() * 2) * speed
      });
    }

    // Rocks Logic
    for (let i = rocks.length - 1; i >= 0; i--) {
      let r = rocks[i];
      r.y += r.vy;

      // Collision
      let dx = player.x - r.x;
      let dy = player.y - r.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      
      if (dist < (r.s/2 + 15)) {
        gameOver();
      }

      if (r.y > canvas.height + 50) {
        rocks.splice(i, 1);
        score += 10;
        scoreEl.innerText = score;
        speed += 0.005;
      }
    }
  }

  function draw() {
    // Clear
    ctx.fillStyle = '#050510';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Stars
    ctx.fillStyle = '#fff';
    stars.forEach(s => {
      s.y += 0.002 * canvas.height;
      if (s.y > 1) s.y = 0;
      ctx.beginPath();
      ctx.arc(s.x * canvas.width, s.y * canvas.height, s.s, 0, Math.PI*2);
      ctx.fill();
    });

    if (running) {
      // Player
      ctx.save();
      ctx.translate(player.x, player.y);
      ctx.fillStyle = keys.dash ? '#fff' : '#00f3ff';
      ctx.shadowBlur = 15; ctx.shadowColor = '#00f3ff';
      ctx.beginPath();
      ctx.moveTo(0, -20); ctx.lineTo(15, 20); ctx.lineTo(0, 10); ctx.lineTo(-15, 20);
      ctx.fill();
      ctx.restore();

      // Rocks
      ctx.shadowBlur = 0;
      ctx.strokeStyle = '#ff0055';
      ctx.lineWidth = 2;
      rocks.forEach(r => {
        ctx.strokeRect(r.x - r.s/2, r.y - r.s/2, r.s, r.s);
        ctx.fillStyle = 'rgba(255,0,85,0.2)';
        ctx.fillRect(r.x - r.s/2, r.y - r.s/2, r.s, r.s);
      });
    }

    if (running) requestAnimationFrame(loop);
  }

  function loop() {
    update();
    draw();
  }

  function gameOver() {
    running = false;
    playTone('hit');
    if (score > highScore) {
      highScore = score;
      localStorage.setItem('neonBest', highScore);
      bestEl.innerText = highScore;
    }
    
    // Show Overlay
    overlay.classList.remove('hidden');
    document.querySelector('h1').innerHTML = "SYSTEM FAIL";
    document.querySelector('p').innerHTML = "SCORE: " + score;
    startBtn.innerText = "üîÑ RETRY";
  }

  // --- CONTROLS FIX ---
  const keys = { left: false, right: false, dash: false };

  // 1. Play Button Fix (Handle Both Touch & Click)
  startBtn.addEventListener('click', (e) => {
    e.preventDefault(); 
    startGame();
  });
  startBtn.addEventListener('touchstart', (e) => {
    e.preventDefault(); // Stop ghost clicks
    startGame();
  });

  // 2. Movement Zones (Kiri / Kanan)
  const zLeft = document.getElementById('zone-left');
  const zRight = document.getElementById('zone-right');

  const bindPress = (elem, key) => {
    elem.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
    elem.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    elem.addEventListener('mousedown', () => keys[key] = true);
    elem.addEventListener('mouseup', () => keys[key] = false);
  };

  bindPress(zLeft, 'left');
  bindPress(zRight, 'right');
  bindPress(btnDash, 'dash');

  // Start background animation
  loop();

</script>
</body>
</html>
