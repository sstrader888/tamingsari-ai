<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GALACTIC WARFARE: STABLE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

  * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0; background: #000;
    font-family: 'Rajdhani', sans-serif;
    overflow: hidden; display: flex; align-items: center; justify-content: center;
    height: 100vh; width: 100vw;
  }

  #gameContainer {
    position: relative; width: 100%; height: 100%; max-width: 550px;
    background: #020205; 
    border-left: 1px solid #333; border-right: 1px solid #333;
    overflow: hidden;
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
  }

  canvas { display: block; width: 100%; height: 100%; z-index: 1; }

  /* UI HUD */
  .hud {
    position: absolute; top: 10px; left: 0; width: 100%;
    padding: 10px 15px; z-index: 10; pointer-events: none;
    display: flex; flex-direction: column; gap: 5px;
    transition: opacity 0.3s;
  }

  .top-row { display: flex; justify-content: space-between; align-items: center; }
  .pilot-name { color: #00eaff; font-size: 14px; font-weight: bold; letter-spacing: 1px; }
  .score-disp { color: #fff; font-size: 20px; font-weight: bold; text-shadow: 0 0 10px #00eaff; }
  
  .level-container { width: 100%; display: flex; align-items: center; gap: 10px; margin-top: 5px; }
  .level-badge { background: #ffaa00; color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 14px; }
  .xp-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; }
  .xp-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00eaff, #00ff88); transition: width 0.2s; }

  /* NOTIFICATIONS */
  .level-up-notif {
    position: absolute; top: 30%; width: 100%; text-align: center;
    color: #ffaa00; font-size: 40px; font-weight: 900; 
    text-shadow: 0 0 20px #ffaa00; z-index: 15;
    opacity: 0; transform: scale(0.5); pointer-events: none;
  }
  .animate-lvl { animation: popScale 1.5s forwards; }

  @keyframes popScale {
    0% { opacity: 0; transform: scale(0.5); }
    20% { opacity: 1; transform: scale(1.2); }
    80% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.5); }
  }

  /* BUTTONS */
  .controls-area {
    position: absolute; bottom: 20px; width: 100%;
    display: flex; justify-content: center; z-index: 20; pointer-events: auto;
  }
  .boost-btn {
    background: rgba(0, 200, 255, 0.1); border: 1px solid rgba(0, 200, 255, 0.5);
    color: #fff; padding: 15px 60px; border-radius: 30px;
    font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: bold;
    backdrop-filter: blur(5px); transition: 0.1s;
  }
  .boost-btn:active { background: rgba(0, 200, 255, 0.4); transform: scale(0.95); }

  /* LOGIN & MENU OVERLAYS */
  .overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(2, 2, 8, 0.95);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100; transition: opacity 0.3s;
  }
  .hidden { opacity: 0; pointer-events: none; }

  h1 { 
    color: #fff; font-size: 42px; text-align: center; margin: 0; 
    text-shadow: 0 0 20px #00eaff; line-height: 1; margin-bottom: 10px;
  }
  .sub { color: #888; letter-spacing: 4px; font-size: 14px; margin-bottom: 40px; text-transform: uppercase;}

  input {
    background: rgba(255,255,255,0.1); border: 1px solid #444; color: #fff;
    padding: 10px 20px; font-size: 18px; text-align: center; border-radius: 5px;
    font-family: 'Rajdhani', sans-serif; margin-bottom: 20px; width: 200px;
  }
  input:focus { outline: none; border-color: #00eaff; }

  .btn-main {
    background: linear-gradient(135deg, #00eaff, #0088ff); color: #000;
    border: none; padding: 12px 50px; font-size: 20px; font-weight: bold;
    clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    cursor: pointer; font-family: 'Rajdhani', sans-serif;
  }
  .btn-main:hover { filter: brightness(1.2); }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; text-align: center; }
  .stat-box h3 { color: #888; font-size: 12px; margin: 0; }
  .stat-box p { color: #fff; font-size: 24px; margin: 5px 0 0 0; font-weight: bold; }

  .touch-zone { position: absolute; top: 0; height: 100%; width: 50%; z-index: 5; }
  #zone-left { left: 0; }
  #zone-right { right: 0; }

</style>
</head>
<body>

<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>
  
  <div id="zone-left" class="touch-zone"></div>
  <div id="zone-right" class="touch-zone"></div>

  <div class="hud" id="hud" style="opacity:0">
    <div class="top-row">
      <div class="pilot-name" id="pilotNameDisp">PILOT</div>
      <div class="score-disp" id="scoreDisp">0</div>
    </div>
    <div class="level-container">
      <div class="level-badge" id="lvlBadge">LVL 1</div>
      <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar"></div></div>
    </div>
  </div>

  <div class="level-up-notif" id="lvlNotif">LEVEL UP!</div>

  <div class="controls-area">
    <button class="boost-btn" id="btnDash">TURBO BOOST</button>
  </div>

  <div class="overlay" id="loginScreen">
    <h1>GALACTIC<br><span style="color:#00eaff">WARFARE</span></h1>
    <div class="sub">ELITE SQUADRON</div>
    
    <input type="text" id="nameInput" placeholder="ENTER PILOT NAME" maxlength="10">
    <button class="btn-main" id="btnLogin">LOGIN SYSTEM</button>
  </div>

  <div class="overlay hidden" id="gameOverScreen">
    <h1 style="color:#ff3333; text-shadow:0 0 20px #ff0000">MISSION<br>FAILED</h1>
    <div class="stats-grid">
      <div class="stat-box"><h3>SCORE</h3><p id="finalScore">0</p></div>
      <div class="stat-box"><h3>LEVEL</h3><p id="finalLevel">1</p></div>
    </div>
    <button class="btn-main" id="btnRetry">RE-DEPLOY</button>
  </div>
</div>

<script>
  // --- CONFIG ---
  const container = document.getElementById('gameContainer');
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  
  const hud = document.getElementById('hud');
  const pilotNameDisp = document.getElementById('pilotNameDisp');
  const scoreDisp = document.getElementById('scoreDisp');
  const lvlBadge = document.getElementById('lvlBadge');
  const xpBar = document.getElementById('xpBar');
  const lvlNotif = document.getElementById('lvlNotif');
  
  const loginScreen = document.getElementById('loginScreen');
  const nameInput = document.getElementById('nameInput');
  const btnLogin = document.getElementById('btnLogin');
  
  const gameOverScreen = document.getElementById('gameOverScreen');
  const btnRetry = document.getElementById('btnRetry');
  const finalScore = document.getElementById('finalScore');
  const finalLevel = document.getElementById('finalLevel');
  const btnDash = document.getElementById('btnDash');

  // --- AUDIO ---
  let actx = null;
  function initAudio() { try { if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)(); if(actx.state==='suspended') actx.resume(); } catch(e){} }
  function sfx(type) {
    if(!actx) return;
    const o = actx.createOscillator(); const g = actx.createGain();
    o.connect(g); g.connect(actx.destination);
    const t = actx.currentTime;
    if(type==='laser'){ o.frequency.setValueAtTime(800,t); o.frequency.exponentialRampToValueAtTime(100,t+0.15); g.gain.setValueAtTime(0.05,t); g.gain.linearRampToValueAtTime(0,t+0.15); }
    if(type==='boom'){ o.type='sawtooth'; o.frequency.setValueAtTime(100,t); o.frequency.exponentialRampToValueAtTime(10,t+0.3); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.3); }
    if(type==='power'){ o.type='square'; o.frequency.setValueAtTime(400,t); o.frequency.linearRampToValueAtTime(800,t+0.2); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.2); }
    o.start(t); o.stop(t+0.4);
  }

  // --- RESIZE ---
  function resize() { canvas.width = container.clientWidth; canvas.height = container.clientHeight; }
  window.addEventListener('resize', resize); setTimeout(resize, 100);

  // --- GAME VARIABLES ---
  let pilotName = localStorage.getItem('gw_pilot') || "";
  if(pilotName) nameInput.value = pilotName;

  let state = 'LOGIN'; // LOGIN, PLAYING, GAMEOVER
  let frame = 0;
  let score = 0;
  let level = 1;
  let xp = 0;
  let xpToNext = 100;
  
  let player = { x:0, y:0, weaponLevel:1 };
  let bullets = [];
  let enemies = [];
  let particles = [];
  let powerups = [];
  let stars = [];
  let planetY = -200;

  const keys = { left:false, right:false, dash:false };

  // --- INIT STARS ---
  for(let i=0; i<60; i++) stars.push({
    x:Math.random(), y:Math.random(), s:Math.random()*2, v:Math.random()*0.5+0.2, blink:Math.random()
  });

  // --- FUNCTIONS ---
  function login() {
    let name = nameInput.value.toUpperCase().trim() || "PILOT";
    pilotName = name;
    localStorage.setItem('gw_pilot', pilotName);
    loginScreen.classList.add('hidden');
    startGame();
  }

  function startGame() {
    initAudio(); 
    resize();
    state = 'PLAYING';
    
    // RESET SEMUA DATA (PENTING SUPAYA TAK BERTINDIH)
    score = 0;
    level = 1;
    xp = 0;
    xpToNext = 500;
    
    player.x = canvas.width/2;
    player.y = canvas.height-150;
    player.weaponLevel = 1;
    
    bullets = []; 
    enemies = []; 
    particles = []; 
    powerups = [];
    
    // UI Update
    hud.style.opacity = 1;
    pilotNameDisp.innerText = pilotName;
    updateHUD();
    
    gameOverScreen.classList.add('hidden');
    
    // *** FIX UTAMA: KITA TAK PANGGIL loop() DI SINI LAGI ***
    // Loop akan berjalan sendiri di bawah
  }

  function addXP(amount) {
    xp += amount;
    score += amount;
    if(xp >= xpToNext) {
      xp = 0;
      level++;
      xpToNext = Math.floor(xpToNext * 1.2);
      lvlNotif.innerText = "LEVEL " + level;
      lvlNotif.classList.remove('animate-lvl');
      void lvlNotif.offsetWidth; 
      lvlNotif.classList.add('animate-lvl');
      sfx('power');
    }
    updateHUD();
  }

  function updateHUD() {
    scoreDisp.innerText = score;
    lvlBadge.innerText = "LVL " + level;
    let pct = (xp / xpToNext) * 100;
    xpBar.style.width = pct + "%";
  }

  function update() {
    if(state !== 'PLAYING') return; // Kalau Game Over, jangan gerakkan objek
    frame++;

    // 1. Difficulty Scaling (Ikut Level)
    let spawnRate = Math.max(20, 60 - (level * 2)); 
    let enemySpeedMult = 1 + (level * 0.05);

    // 2. Player Move
    let speed = keys.dash ? 9 : 5;
    if(keys.left) player.x -= speed;
    if(keys.right) player.x += speed;
    if(player.x < 25) player.x = 25;
    if(player.x > canvas.width-25) player.x = canvas.width-25;

    // 3. Auto Shoot
    if(frame % 15 === 0) {
      if(player.weaponLevel === 1) {
        bullets.push({x:player.x, y:player.y-30, vx:0, vy:-15});
      } else if(player.weaponLevel === 2) {
        bullets.push({x:player.x-10, y:player.y-30, vx:0, vy:-15});
        bullets.push({x:player.x+10, y:player.y-30, vx:0, vy:-15});
      } else { 
        bullets.push({x:player.x, y:player.y-30, vx:0, vy:-15});
        bullets.push({x:player.x, y:player.y-30, vx:-3, vy:-14});
        bullets.push({x:player.x, y:player.y-30, vx:3, vy:-14});
      }
      sfx('laser');
    }

    // 4. Bullets Move
    for(let i=bullets.length-1; i>=0; i--) {
      let b = bullets[i];
      b.x += b.vx; b.y += b.vy;
      if(b.y < -20) bullets.splice(i,1);
    }

    // 5. Spawn Enemy
    if(frame % spawnRate === 0) {
      let tier = 1;
      if(level > 5 && Math.random()>0.7) tier = 2;
      if(level > 10 && Math.random()>0.9) tier = 3;

      enemies.push({
        x: Math.random()*(canvas.width-60)+30,
        y: -50,
        tier: tier,
        hp: tier * 2 + Math.floor(level/5),
        w: tier===1?30: (tier===2?50:70),
        s: (Math.random()*2+2) * enemySpeedMult
      });
    }

    // 6. Enemy Logic
    for(let i=enemies.length-1; i>=0; i--) {
      let e = enemies[i];
      e.y += e.s;

      if(Math.abs(e.x - player.x) < (e.w/2 + 20) && Math.abs(e.y - player.y) < 40) {
        gameOver();
      }

      for(let j=bullets.length-1; j>=0; j--) {
        let b = bullets[j];
        if(Math.abs(b.x - e.x) < e.w/2 && Math.abs(b.y - e.y) < 30) {
          particles.push({x:b.x, y:b.y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, life:10, c:'#fff'});
          bullets.splice(j,1);
          e.hp--;
          if(e.hp <= 0) {
            // Drop powerup?
            if(Math.random() < 0.1) powerups.push({ x:e.x, y:e.y });
            
            addXP(e.tier * 50);
            sfx('boom');
            for(let p=0; p<10; p++) particles.push({x:e.x, y:e.y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, life:20, c:'#f50'});
            enemies.splice(i,1);
          }
          break;
        }
      }
      if(e.y > canvas.height+50) enemies.splice(i,1);
    }

    // 7. Powerups
    for(let i=powerups.length-1; i>=0; i--) {
      let p = powerups[i];
      p.y += 3;
      if(Math.abs(p.x - player.x) < 30 && Math.abs(p.y - player.y) < 30) {
        player.weaponLevel = Math.min(3, player.weaponLevel+1);
        sfx('power');
        powerups.splice(i,1);
        particles.push({x:player.x, y:player.y-40, vx:0, vy:-1, life:40, txt:"WEAPON UP!"});
      }
      if(p.y > canvas.height) powerups.splice(i,1);
    }

    // 8. Particles
    for(let i=particles.length-1; i>=0; i--) {
      let p = particles[i];
      p.x += p.vx || 0; p.y += p.vy || 0; p.life--;
      if(p.life <= 0) particles.splice(i,1);
    }

    planetY += 0.2;
    if(planetY > canvas.height + 200) planetY = -200;
  }

  function draw() {
    ctx.fillStyle = "#020205"; ctx.fillRect(0,0,canvas.width,canvas.height);

    // Stars & Planet (Sentiasa gerak walaupun menu)
    ctx.fillStyle = "#fff";
    stars.forEach(s => {
      s.y += s.v * (keys.dash?4:1); if(s.y>1) s.y=0;
      let alpha = 0.5 + Math.sin(frame * 0.1 + s.blink)*0.5;
      ctx.globalAlpha = alpha;
      ctx.beginPath(); ctx.arc(s.x*canvas.width, s.y*canvas.height, s.s, 0, Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha = 1;

    ctx.save();
    let gradP = ctx.createRadialGradient(canvas.width*0.8, planetY, 10, canvas.width*0.8, planetY, 150);
    gradP.addColorStop(0, "#4444ff"); gradP.addColorStop(0.5, "#000055"); gradP.addColorStop(1, "transparent");
    ctx.fillStyle = gradP; ctx.beginPath(); ctx.arc(canvas.width*0.8, planetY, 150, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    if(state === 'PLAYING') {
      // Powerups
      powerups.forEach(p => {
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(frame * 0.05);
        ctx.shadowBlur = 15; ctx.shadowColor = "#00ff00";
        ctx.fillStyle = "#00ff00"; ctx.fillRect(-10, -10, 20, 20);
        ctx.fillStyle = "#fff"; ctx.font="bold 12px Arial"; ctx.fillText("W", -5, 4);
        ctx.restore();
      });

      // Player
      ctx.save(); ctx.translate(player.x, player.y);
      let pGrad = ctx.createLinearGradient(-20, 0, 20, 0);
      pGrad.addColorStop(0, "#0055aa"); pGrad.addColorStop(0.5, "#88ccff"); pGrad.addColorStop(1, "#0055aa");
      
      ctx.fillStyle = "#003366"; 
      ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(-25,25); ctx.lineTo(-10,20); ctx.fill(); 
      ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(25,25); ctx.lineTo(10,20); ctx.fill(); 
      
      ctx.fillStyle = pGrad;
      ctx.beginPath(); ctx.moveTo(0,-35); ctx.lineTo(10,20); ctx.lineTo(0,30); ctx.lineTo(-10,20); ctx.fill();
      
      if(keys.dash) {
        ctx.shadowBlur = 20; ctx.shadowColor = "#00ffff";
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.moveTo(-5,30); ctx.lineTo(0,50); ctx.lineTo(5,30); ctx.fill();
      }
      ctx.restore();

      // Bullets
      ctx.shadowBlur = 10; ctx.shadowColor = "#ffff00"; ctx.fillStyle = "#ffffaa";
      bullets.forEach(b => ctx.fillRect(b.x-2, b.y-10, 4, 15));
      ctx.shadowBlur = 0;

      // Enemies
      enemies.forEach(e => {
        ctx.save(); ctx.translate(e.x, e.y);
        let c1 = e.tier===1 ? "#cc0000" : (e.tier===2 ? "#aa00aa" : "#ff8800");
        let eGrad = ctx.createLinearGradient(0, -e.w/2, 0, e.w/2);
        eGrad.addColorStop(0, c1); eGrad.addColorStop(1, "#330000");
        ctx.fillStyle = eGrad;
        
        if(e.tier === 1) { 
           ctx.beginPath(); ctx.moveTo(0,15); ctx.lineTo(15,-15); ctx.lineTo(0,-5); ctx.lineTo(-15,-15); ctx.fill();
        } else if(e.tier === 2) { 
           ctx.beginPath(); ctx.moveTo(0,25); ctx.lineTo(20,-20); ctx.lineTo(-20,-20); ctx.fill();
           ctx.fillStyle="#fff"; ctx.fillRect(-5,-25,10,5); 
        } else { 
           ctx.beginPath(); ctx.moveTo(0,35); ctx.lineTo(30,-10); ctx.lineTo(15,-30); ctx.lineTo(-15,-30); ctx.lineTo(-30,-10); ctx.fill();
        }
        ctx.restore();
      });

      // Particles
      particles.forEach(p => {
        if(p.txt) { ctx.fillStyle = "#fff"; ctx.font = "bold 14px Arial"; ctx.fillText(p.txt, p.x-30, p.y); } 
        else { ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, 3, 3); }
      });
    }
  }

  // GAME LOOP (THE FIX: Always running 1 loop)
  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }

  function gameOver() {
    state = 'GAMEOVER';
    sfx('boom');
    hud.style.opacity = 0;
    gameOverScreen.classList.remove('hidden');
    finalScore.innerText = score;
    finalLevel.innerText = level;
  }

  // --- INPUT ---
  btnLogin.addEventListener('click', login);
  btnRetry.addEventListener('click', startGame);

  const bindT = (id,k) => {
    let el = document.getElementById(id);
    el.addEventListener('touchstart', (e)=>{e.preventDefault(); keys[k]=true;});
    el.addEventListener('touchend', (e)=>{e.preventDefault(); keys[k]=false;});
    el.addEventListener('mousedown', ()=>{keys[k]=true;});
    el.addEventListener('mouseup', ()=>{keys[k]=false;});
  }
  bindT('zone-left','left'); bindT('zone-right','right'); bindT('btnDash','dash');

  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft') keys.left=true; if(e.key==='ArrowRight') keys.right=true; if(e.code==='Space') keys.dash=true;
  });
  window.addEventListener('keyup', e=>{
    if(e.key==='ArrowLeft') keys.left=false; if(e.key==='ArrowRight') keys.right=false; if(e.code==='Space') keys.dash=false;
  });

  // START ENGINE
  loop(); 

</script>
</body>
</html>
